<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sensodimension · Reproductor Mandálico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA -->
  <meta name="theme-color" content="#1e1630" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" />
  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(circle at top left, #ff9a9e 0%, #fad0c4 30%, #a18cd1 60%, #2b5876 100%);
      color: #fdfdfd;
    }

    .frame {
      width: 100%;
      max-width: 480px;
      border-radius: 26px;
      background: rgba(10, 12, 28, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .video-area {
      position: relative;
      background: #000;
    }

    .video-area video {
      width: 100%;
      height: 240px;
      object-fit: cover;
      display: block;
    }

    @media (min-height: 780px) {
      .video-area video {
        height: 280px;
      }
    }

    .video-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), transparent 45%, rgba(0, 0, 0, 0.45));
      pointer-events: none;
    }

    .video-label {
      position: absolute;
      left: 12px;
      bottom: 10px;
      padding: 5px 12px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.25);
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .video-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #14ff72;
      box-shadow: 0 0 10px #14ff72;
    }

    .bottom-area {
      padding: 14px 16px 10px 16px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .title-group h1 {
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .title-group h1 span {
      font-weight: 700;
    }

    .title-group p {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 3px;
    }

    .status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.16);
      white-space: nowrap;
    }

    .track-info {
      margin: 4px 0 8px;
    }

    .track-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .track-sub {
      font-size: 0.8rem;
      opacity: 0.75;
      margin-top: 2px;
    }

    .controls-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 8px 0 14px;
      flex-wrap: wrap;
    }

    .btn {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.08);
      color: #fefefe;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      transition: transform 0.14s ease, box-shadow 0.14s ease, background 0.14s ease, opacity 0.14s ease;
    }

    .btn:active {
      transform: scale(0.95) translateY(1px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.16);
    }

    .btn-main {
      width: 52px;
      height: 52px;
      font-size: 1.3rem;
      background: linear-gradient(135deg, #ffb75e, #ed8f03);
    }

    .progress-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      opacity: 0.9;
      margin-bottom: 6px;
    }

    .progress-bar {
      position: relative;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.12);
      overflow: hidden;
      cursor: pointer;
    }

    .progress-fill {
      position: absolute;
      inset: 0 100% 0 0;
      background: linear-gradient(90deg, #ffb75e, #ff6f91, #9b5cff);
      transition: inset 0.08s linear;
    }

    /* ====== BOTÓN DE INSTALACIÓN MANDÁLICO (OPCIÓN B) ====== */
    .install-row{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      margin: 2px 0 8px;
    }

    .install-btn{
      position:relative;
      width: 100%;
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background:
        radial-gradient(circle at 20% 10%, rgba(255,183,94,0.35), transparent 40%),
        radial-gradient(circle at 80% 0%, rgba(155,92,255,0.35), transparent 45%),
        linear-gradient(135deg, rgba(255,111,145,0.9), rgba(255,183,94,0.9));
      color: #fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size:0.9rem;
      font-weight:700;
      letter-spacing:0.02em;
      box-shadow: 0 10px 26px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.06);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .12s ease;
      opacity:0;
      transform: translateY(6px) scale(0.98);
      pointer-events:none;
      overflow: hidden;
    }

    .install-btn.show{
      opacity:1;
      transform: translateY(0) scale(1);
      pointer-events:auto;
    }

    .install-btn:active{
      transform: scale(0.98);
      filter:saturate(1.06);
    }

    .install-mandala{
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background:
        conic-gradient(from 0deg,
          #ffb75e, #ff6f91, #9b5cff, #14ff72, #ffb75e);
      box-shadow: 0 0 14px rgba(255,255,255,0.25);
      position:relative;
      animation: mandalaPulse 2.6s ease-in-out infinite;
      flex: 0 0 auto;
    }

    .install-mandala::after{
      content:"";
      position:absolute;
      inset:4px;
      border-radius:999px;
      background: rgba(10,12,28,0.85);
      border:1px solid rgba(255,255,255,0.2);
    }

    .install-text{
      display:inline-block;
      text-shadow: 0 1px 8px rgba(0,0,0,0.35);
      white-space: nowrap;
    }

    .install-hint{
      font-size:0.72rem;
      opacity:0.75;
      text-align:center;
      max-width: 95%;
    }

    @keyframes mandalaPulse {
      0%   { transform: scale(0.96); filter: saturate(1); box-shadow: 0 0 10px rgba(255,255,255,0.18); }
      50%  { transform: scale(1.12); filter: saturate(1.15); box-shadow: 0 0 18px rgba(255,255,255,0.35); }
      100% { transform: scale(0.96); filter: saturate(1); box-shadow: 0 0 10px rgba(255,255,255,0.18); }
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 4px;
      flex-wrap: wrap;
      gap: 4px;
    }

    .indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .indicator-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #777;
    }

    .indicator-dot.on {
      background: #14ff72;
      box-shadow: 0 0 10px #14ff72;
    }

    .credits {
      padding: 6px 16px 10px 16px;
      font-size: 0.7rem;
      opacity: 0.8;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      line-height: 1.4;
      background: rgba(10, 12, 28, 0.9);
    }
  </style>
</head>
<body>

  <div class="frame">
    <!-- VIDEO ARRIBA -->
    <div class="video-area">
      <video id="mandalaVideo" playsinline muted preload="metadata"></video>
      <div class="video-overlay"></div>
      <div class="video-label">
        <span class="video-dot"></span>
        <span>Sensodimension · Mandalas en movimiento</span>
      </div>
    </div>

    <!-- CONTROLES ABAJO -->
    <div class="bottom-area">
      <div class="header-row">
        <div class="title-group">
          <h1><span>Sensodimension</span> Player</h1>
          <p>Audio aleatorio para relajación y meditación con mandalas animados.</p>
        </div>
        <div class="status-pill" id="modeLabel">
          Modo: Aleatorio · PWA
        </div>
      </div>

      <div class="track-info">
        <div class="track-title" id="trackTitle">Cargando pista aleatoria…</div>
        <div class="track-sub">Pulsa ▶ para iniciar la sesión.</div>
      </div>

      <div class="controls-row">
        <button class="btn" id="prevBtn" title="Cambiar pista (aleatoria)">⏮</button>
        <button class="btn btn-main" id="playBtn" title="Play / Reanudar">▶</button>
        <button class="btn" id="pauseBtn" title="Pausa">⏸</button>
        <button class="btn" id="stopBtn" title="Stop">⏹</button>
        <button class="btn" id="nextBtn" title="Cambiar pista (aleatoria)">⏭</button>
      </div>

      <div class="progress-row">
        <span id="currentTime">0:00</span>
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <span id="duration">0:00</span>
      </div>

      <!-- BOTÓN DE INSTALACIÓN (OPCIÓN B: debajo de progreso) -->
      <div class="install-row">
        <button id="installBtn" class="install-btn" onclick="installApp()" aria-label="Instalar Sensodimension">
          <span class="install-mandala"></span>
          <span class="install-text">Instalar Sensodimension</span>
        </button>
        <div id="installHint" class="install-hint">
          Disponible cuando el navegador permita instalación.
        </div>
      </div>

      <div class="footer-row">
        <div class="indicator">
          <span class="indicator-dot" id="audioStatusDot"></span>
          <span id="audioStatusLabel">Detenido</span>
        </div>
        <span>Los mandalas se detienen cuando paras la música.</span>
      </div>
    </div>

    <!-- CRÉDITOS AL PIE -->
    <div class="credits">
      Concepto, realización, temas musicales y videos mandalas creados por:<br>
      <strong>Victor M. F. Avilan · Valor Agregado</strong>
    </div>
  </div>

  <!-- AUDIO INVISIBLE -->
  <audio id="audioElement" preload="metadata"></audio>

  <script>
    // ====== PLAYLISTS (MP3 compatibles para móvil / PWA) ======
    const audioPlaylist = [
      "audio/01_dawns_tidal.mp3",
      "audio/02_depths_tranquility.mp3",
      "audio/03_desert_night_awake.mp3",
      "audio/04_dronelab.mp3",
      "audio/05_lunar_dialogue.mp3",
      "audio/06_moonlit_ceremony.mp3",
      "audio/07_moonlit_sanctuary.mp3",
      "audio/08_night_forest_dialogue.mp3",
      "audio/09_night_forest_temple.mp3",
      "audio/10_night_grove_ceremony.mp3",
      "audio/11_night_river_passage.mp3",
      "audio/12_night_spirit_dialogue.mp3",
      "audio/13_night_tide_meditation.mp3",
      "audio/14_nights_gentle_passage.mp3",
      "audio/15_ocean_breath.mp3",
      "audio/16_ocean_depths_ascension.mp3",
      "audio/17_ocean_depths_meditation.mp3",
      "audio/18_ocean_zen.mp3",
      "audio/19_pond_midnight.mp3",
      "audio/20_sacred_waters.mp3",
      "audio/21_seaside_theta.mp3"
    ];

    // Videos (deja estos nombres tal como están en tu carpeta /video)
    const mandalaVideos = [
      "video/Mandala Beta relax.mp4",
      "video/Mandala onda relajacion piano.mp4",
      "video/Mandala theta-zen_VR.mp4.mp4"
    ];

    // ====== ELEMENTOS ======
    const audioEl = document.getElementById("audioElement");
    const mandalaVideoEl = document.getElementById("mandalaVideo");

    const trackTitleEl = document.getElementById("trackTitle");
    const currentTimeEl = document.getElementById("currentTime");
    const durationEl = document.getElementById("duration");
    const progressBarEl = document.getElementById("progressBar");
    const progressFillEl = document.getElementById("progressFill");
    const audioStatusDot = document.getElementById("audioStatusDot");
    const audioStatusLabel = document.getElementById("audioStatusLabel");

    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn = document.getElementById("stopBtn");
    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");

    // Instalación PWA
    const installBtn = document.getElementById("installBtn");
    const installHint = document.getElementById("installHint");
    let deferredPrompt = null;

    function logDebug(msg) {
      console.log("[Sensodimension]", msg);
    }

    // ====== AJUSTE DE AUDIO ======
    audioEl.volume = 1.0;
    audioEl.muted = false;

    audioEl.addEventListener("error", () => {
      const e = audioEl.error;
      logDebug("Error de audio: code=" + (e && e.code));
    });

    // ====== ESTADO ======
    let currentTrackIndex = -1;
    let currentMandalaIndex = -1;

    // ====== UTILIDADES ======
    function getReadableName(path) {
      const file = path.split("/").pop();
      const noExt = file.replace(/\.[^/.]+$/, "");
      return noExt.replace(/[_-]+/g, " ");
    }

    function formatTime(seconds) {
      if (isNaN(seconds) || !isFinite(seconds)) return "0:00";
      const s = Math.floor(seconds % 60);
      const m = Math.floor(seconds / 60);
      const sStr = s < 10 ? "0" + s : s;
      return m + ":" + sStr;
    }

    function updateStatus(isPlaying) {
      if (isPlaying) {
        audioStatusDot.classList.add("on");
        audioStatusLabel.textContent = "Reproduciendo";
      } else if (audioEl.currentTime > 0 && !audioEl.paused) {
        audioStatusDot.classList.remove("on");
        audioStatusLabel.textContent = "Pausado";
      } else {
        audioStatusDot.classList.remove("on");
        audioStatusLabel.textContent = "Detenido";
      }
    }

    function pickRandomTrackIndex(excludeIndex) {
      if (!audioPlaylist.length) return -1;
      if (audioPlaylist.length === 1) return 0;
      let idx;
      do {
        idx = Math.floor(Math.random() * audioPlaylist.length);
      } while (idx === excludeIndex);
      return idx;
    }

    function pickRandomMandalaIndex(excludeIndex) {
      if (!mandalaVideos.length) return -1;
      if (mandalaVideos.length === 1) return 0;
      let idx;
      do {
        idx = Math.floor(Math.random() * mandalaVideos.length);
      } while (idx === excludeIndex);
      return idx;
    }

    // ====== AUDIO ======
    function loadTrackByIndex(index) {
      if (index < 0 || index >= audioPlaylist.length) return;
      currentTrackIndex = index;
      const trackPath = audioPlaylist[currentTrackIndex];
      audioEl.pause();
      audioEl.currentTime = 0;
      audioEl.src = trackPath;
      audioEl.load();
      logDebug("Cargando pista: " + trackPath);
      trackTitleEl.textContent = getReadableName(trackPath);
      progressFillEl.style.inset = "0 100% 0 0";
      currentTimeEl.textContent = "0:00";
      durationEl.textContent = "0:00";
    }

    function playCurrentTrack() {
      if (currentTrackIndex === -1) {
        const idx = pickRandomTrackIndex(-1);
        loadTrackByIndex(idx);
      }

      audioEl.muted = false;
      audioEl.volume = 1.0;

      audioEl.play().then(() => {
        syncMandalaWithAudio(true);
        updateStatus(true);
      }).catch(err => {
        logDebug("Error al reproducir audio: " + err);
      });
    }

    function playRandomTrack() {
      const nextIndex = pickRandomTrackIndex(currentTrackIndex);
      loadTrackByIndex(nextIndex);
      playCurrentTrack();
    }

    function pauseCurrentTrack() {
      audioEl.pause();
      syncMandalaWithAudio(false);
      updateStatus(false);
    }

    function stopCurrentTrack() {
      audioEl.pause();
      audioEl.currentTime = 0;
      syncMandalaWithAudio(false);
      updateStatus(false);
    }

    // ====== VIDEO MANDALAS ======
    function playRandomMandala() {
      const nextIndex = pickRandomMandalaIndex(currentMandalaIndex);
      if (nextIndex === -1) return;
      currentMandalaIndex = nextIndex;
      mandalaVideoEl.src = mandalaVideos[currentMandalaIndex];
      mandalaVideoEl.currentTime = 0;

      mandalaVideoEl.play().catch(err => {
        logDebug("No se pudo reproducir video: " + err);
      });
    }

    function syncMandalaWithAudio(isPlaying) {
      if (isPlaying) {
        if (mandalaVideoEl.paused || mandalaVideoEl.ended || !mandalaVideoEl.src) {
          playRandomMandala();
        } else {
          mandalaVideoEl.play().catch(() => {});
        }
      } else {
        mandalaVideoEl.pause();
      }
    }

    // ====== EVENTOS AUDIO ======
    audioEl.addEventListener("loadedmetadata", () => {
      durationEl.textContent = formatTime(audioEl.duration);
    });

    audioEl.addEventListener("timeupdate", () => {
      const current = audioEl.currentTime;
      const dur = audioEl.duration || 0;
      currentTimeEl.textContent = formatTime(current);

      if (dur > 0) {
        const percent = current / dur;
        const rightInset = (1 - percent) * 100;
        progressFillEl.style.inset = `0 ${rightInset}% 0 0`;
      }
    });

    audioEl.addEventListener("play", () => {
      updateStatus(true);
      syncMandalaWithAudio(true);
    });

    audioEl.addEventListener("pause", () => {
      updateStatus(false);
      syncMandalaWithAudio(false);
    });

    audioEl.addEventListener("ended", () => {
      playRandomTrack();
    });

    // ====== EVENTOS VIDEO ======
    mandalaVideoEl.addEventListener("ended", () => {
      if (!audioEl.paused && !audioEl.ended) {
        playRandomMandala();
      }
    });

    // ====== CONTROLES ======
    playBtn.addEventListener("click", playCurrentTrack);
    pauseBtn.addEventListener("click", pauseCurrentTrack);
    stopBtn.addEventListener("click", stopCurrentTrack);
    nextBtn.addEventListener("click", playRandomTrack);
    prevBtn.addEventListener("click", playRandomTrack);

    progressBarEl.addEventListener("click", (event) => {
      const rect = progressBarEl.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const ratio = x / rect.width;
      if (!isNaN(audioEl.duration) && audioEl.duration > 0) {
        audioEl.currentTime = ratio * audioEl.duration;
      }
    });

    // ====== INSTALACIÓN MANUAL DE PWA ======
    window.addEventListener("beforeinstallprompt", (event) => {
      event.preventDefault();
      deferredPrompt = event;
      if (installBtn) installBtn.classList.add("show");
      if (installHint) installHint.textContent = "Instala la app para usarla como nativa.";
      logDebug("PWA lista para instalar");
    });

    window.addEventListener("appinstalled", () => {
      deferredPrompt = null;
      if (installBtn) installBtn.classList.remove("show");
      if (installHint) installHint.textContent = "Aplicación instalada ✅";
      logDebug("App instalada");
    });

    async function installApp() {
      if (!deferredPrompt) {
        if (installHint) installHint.textContent = "Aún no disponible. Abre en Chrome/Edge y recarga.";
        logDebug("Instalación no disponible todavía");
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      logDebug("Resultado instalación: " + choice.outcome);
      deferredPrompt = null;
      if (installBtn) installBtn.classList.remove("show");
    }

    // ====== REGISTRO SERVICE WORKER ======
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js").catch(err => {
          console.log("SW no registrado:", err);
        });
      });
    }

    // ====== INICIO ======
    (function init() {
      if (!audioPlaylist.length) {
        trackTitleEl.textContent = "No hay pistas de audio configuradas";
        logDebug("No hay pistas configuradas.");
        return;
      }
      updateStatus(false);
      logDebug("Listo. Pulsa ▶ para empezar.");
    })();
  </script>

</body>
</html>
